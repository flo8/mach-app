---
import { UserCircleIcon } from '@heroicons/vue/24/outline';
---

<div id='isLoggedIn' class='hidden'>
  <button
    type='button'
    class='ml-5 rounded-full p-2.5 text-center inline-flex items-center mr-2 focus:ring-4 bg-gray-800 focus:ring-gray-300 dark:focus:ring-gray-600'
    id='user-menu-button'
    aria-expanded='false'
    data-dropdown-toggle='user-dropdown'
    data-dropdown-placement='bottom'
  >
    <span class='sr-only'>Open user menu</span>
    <UserCircleIcon class='h-6 h-6 text-gray-100' />
  </button>
  <!-- Dropdown menu -->

  <div
    class='hidden absolute -translate-y-2 -translate-x-20 z-50 my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700 dark:divide-gray-600'
    id='user-dropdown'
  >
    <div class='px-4 py-3'>
      <span id='userName' class='block text-sm text-gray-900 dark:text-white'></span>
      <span
        id='xpPoints'
        class='block text-sm font-medium text-gray-500 truncate dark:text-gray-400'></span>
    </div>
    <ul class='py-2' aria-labelledby='user-menu-button'>
      <li>
        <a
          href={`${import.meta.env.BASE_URL}profile/`}
          class='block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white'
          >Profil</a
        >
      </li>
      <li>
        <button
          id='logout'
          class='block text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white'
          type='button'>Sign out</button
        >
      </li>
    </ul>
  </div>
</div>

<a
  id='isNotLoggedIn'
  href={`${import.meta.env.BASE_URL}login/`}
  class:list={[
    'hidden mr-5 menu-item text-center py-2.5 px-6 text-purple-700 rounded-md border hover:text-white border-purple-700 hover:bg-purple-800 focus:ring-4 focus:outline-none focus:ring-purple-300 dark:border-purple-400 dark:text-purple-400 dark:hover:text-white dark:hover:bg-purple-500 dark:focus:ring-purple-900',
    { active: Astro.url.pathname === `${import.meta.env.BASE_URL}login/` }
  ]}
>
  Login
</a>

<script>
  import { getUser, logout } from '@utils/auth';
  try {
    let element: HTMLElement | null;
    const user = await getUser();
    if (user !== null) {
      element = document.getElementById('isLoggedIn');
      const xpPoints = document.getElementById('xpPoints');
      const mail = document.createTextNode(`${user?.user_metadata?.xp} Points`);
      xpPoints?.appendChild(mail);
      const userName = document.getElementById('userName');
      const name = document.createTextNode(user?.user_metadata?.username || '');
      userName?.appendChild(name);
    } else {
      element = document.getElementById('isNotLoggedIn');
    }
    element?.classList.toggle('hidden');
  } catch (error) {}

  const handleLogoutClick = () => {
    logout();
    // window.location.href = `../../`;
    window.location.assign(`${import.meta.env.BASE_URL}`);
  };

  document.getElementById('logout')?.addEventListener('click', handleLogoutClick);

  const handleMenuClick = () => {
    const element = document.getElementById('user-dropdown');
    element?.classList.toggle('hidden');
  };

  document.getElementById('user-menu-button')?.addEventListener('click', handleMenuClick);
</script>
