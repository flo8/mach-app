---
title: テスト
description: コードのテスト方法を学びましょう。
lastmod: 2023-05-26T03:02:00.508Z
---

# Goでコードをテストする

この章では、ユニットテストの作成と実行について見ていきます。

## はじめに

この章では以下の内容をカバーします：

- なぜコードをテストする必要があるのか。
- Goのテストライブラリ。
- テストの作成と実行。
- テストの実行方法の制御。
- カバレッジレポートの生成。

## テストする理由

コードをテストして、意図した通りに動作することを確認することは良いことです。この章では特にユニットテストに焦点を当てています。

## Goが提供するもの

Goには、`testing`というパッケージがあり、次の2つの機能を提供しています：

- テストのためのパラメータ。`testing`ライブラリは`t *testing.T`パラメータを公開しています。このパラメータを関数のパラメータとして指定することで、その関数はテストとなります。

  ```go
  func TestAdd(t *testing.T) {}
  ```

- 結果のアサート方法。`testing`は`t.Errorf()`も公開しています。この関数を文字列と共に呼び出すことで、テストは失敗となります。テストをパスするには何も行いません：

  ```go
  t.Errorf("Sum was incorrect, Actual: %d, Expected: %d", total, 4)
  ```

以下はテスト関数の例です：

```go
func TestAdd(t *testing.T) {
 total := Add(2, 2)
 if total != 4 {
  t.Errorf("Sum was incorrect, Actual: %d, Expected: %d", total, 4)
 }
 t.Log("running TestAdd")
}
```

- まず、テストするコードが呼び出されます：

  ```go
  total := Add(2, 2)
  ```

- 次に、アサーションが行われ、成功または失敗を判定します：

  ```go
  if total != 4 {
    t.Errorf("Sum was incorrect, Actual: %d, Expected: %d", total, 4)
  }
  ```

  結果が期待値と異なる場合は、`t.Errorf()`が呼び出され、何が間違っているかが示されます。

## 最初のテスト

`go mod init`を使用してプロジェクトを作成してください。次に、次のようなファイル構造を作成します：

```
main.go
math/
  math.go
```

次に、テストファイルを作成します。テストファイルは、テストしたいコードにできるだけ近い場所に配置することが望ましいです。`math.go`をテストしたいので、`math/`ディレクトリに`math_test.go`ファイルを作成します：

```
main.go
math/
  math.go
  math_test.go
```

### テストの作成と実行

上記のファイル構造ができたら、`math_test.go`ファイルに以下の内容が含まれていることを確認してください：

```go
package math

import (
 "testing"
)

func TestAdd(t *testing.T) {
  total := Add(2, 2)
  if total != 4 {
    t.Errorf("Sum was incorrect, Actual: %d, Expected: %d", total, 4)
  }
  t.Log("running TestAdd")
}
```

テストを実行するには、`go test`コマンドを使用します。テストを実行するさまざまな方法は次のとおりです：

- `go test`：現在の作業ディレクトリでテストを実行します。実行結果は次のようになります：

  ```
  ok      test-example/math       0.258s
  ```

- `go test -v`：詳細なバージョンで実行します。実行結果は次のようになります：

  ```
  === RUN   TestAdd
   math_test.go:12: running TestAdd

  --- PASS: TestAdd (0.00s)
  PASS
  ok      test-example/math       0.422s
  ```

  詳細なバージョンでは、テストの名前と失敗したかどうかが表示されます。

- `go test ./..`：再帰的に実行します。このようにコマンドを実行すると、サブフォルダ内のすべてのテストが実行されます。

## テストの実行を制御する

テストの実行方法を制御する方法があります。いくつかの方法を紹介します：

- **パターンによるテストの実行**：テストの一部を実行するためにパターンを指定できます。部分一致や特定の深さなどで一致させることができます。次のように指定します：

  ```console
  go test -run <pattern>
  ```

- **テストのスキップ**：`t.Skip()`をテスト内で呼び出すことで、テストをスキップすることができます。
- **単一のテストの実行**：パッケージとテストの名前を指定するパターンを実行することで、単一のテストを実行できます。次のように実行します：

  ```console
  go test -run TestAdd ./math
  ```

  ここでは、パッケージ名が`math`で、テストの名前が`TestAdd()`です。

## カバレッジ

カバレッジに関する取り扱いには、組み込みのツールがあります。ツールについて詳しく知るには、次のコマンドを入力します：

```console
go tool cover -help
```

これにより、一連のコマンドが表示されます。

このツールは、カバレッジの範囲を示す「outファイル」を持つことを中心にしています。outファイルには、テストでコードがカバーされている場所とされていない場所の指示が含まれています。outファイルは次のような形式になります：

```
mode: set
test-example/math/math.go:3.32,5.2 1 1
test-example/math/math.go:7.37,9.2 1 1
test-example/math/math.go:11.47,13.2 1 0
```

これはツールで読み取れる形式です。

コードのカバレッジを表示する前に、上記の「outファイル」を生成する必要があります。カバレッジを測定したいディレクトリに移動し、次のコマンドを実行します：

```console
go test -coverprofile=c.out
```

これで、結果をブラウザで表示するコマンドを実行する準備が整いました：

```console
go tool cover -html=c.out
```

上記のコマンドはブラウザを起動し、次のような出力が表示されます：

![coverage](coverage.png)

カバレッジレポートによれば、緑色の部分はテストでカバーされており、赤色の部分はテストが必要です。

## もっと学ぶ

Goでのテストについては、パッケージのドキュメント[docs](https://pkg.go.dev/testing)を参照してください。

## チャレンジ

自分が書いたコードのテストを作成してください。テストを実行し、カバレッジレポートを生成し、レポートで指摘された不足部分を実装できるか試してみてください。